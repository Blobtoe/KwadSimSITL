os:
  - linux
  - osx

osx_image: xcode10.3

sudo: false

dist: bionic

addons:
  apt:
    packages:
      - lcov
      - build-essential
      - git
      - libc6-i386
      - time
      - mingw-w64
      - wine64

git:
  depth: 5

language: cpp
compiler: gcc

before_install:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew update       ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install lcov ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew upgrade cmake; fi

before_script:
  - gcc --version

script: ./.travis.sh

after_success:
# Create lcov report
  - lcov --capture --directory . --output-file coverage.info
  - lcov --remove coverage.info '/usr/*' --output-file coverage.info # filter system-files
  - lcov --remove coverage.info "$TRAVIS_BUILD_DIR/test/*" --output-file coverage.info # filter catch
  - lcov --remove coverage.info "$TRAVIS_BUILD_DIR/external/betaflight/*" --output-file coverage.info # filter betaflight internal
  - lcov --list coverage.info # debug info
# Uploading report to CodeCov
  - bash <(curl -s https://codecov.io/bash) -f coverage.info || echo "Codecov did not collect coverage reports"